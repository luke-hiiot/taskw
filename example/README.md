# E-commerce API - TaskW Testing Example

This is a comprehensive example e-commerce API that **requires taskw** to function. The project is structured to demonstrate how a real-world application should be built to rely entirely on taskw for route registration and dependency injection.

## Important: This Project Won't Work Without TaskW

🚨 **This example project will NOT compile or run until you generate the required code using taskw.**

- The routes are not manually registered - taskw must scan `@Router` annotations and generate them
- The dependency injection is not manually wired - taskw must scan `Provide*` functions and generate Wire provider sets

## What This Example Demonstrates

This project showcases the complete taskw workflow:

### 🎯 Handler Functions with @Router Annotations

Every handler method includes proper Swaggo annotations:

```go
// GetUsers retrieves all users
// @Summary Get all users
// @Description Get a list of all users in the system
// @Tags users
// @Accept json
// @Produce json
// @Success 200 {array} models.UserResponse
// @Failure 500 {object} map[string]string
// @Router /api/v1/users [get]
func (h *Handler) GetUsers(c *fiber.Ctx) error {
    // implementation
}
```

### 📦 Provider Functions for Wire DI

Every module includes provider functions:

```go
// ProvideHandler creates a new user handler
func ProvideHandler(service *Service) *Handler {
    return &Handler{service: service}
}

// ProvideService creates a new user service
func ProvideService(repo *Repository) *Service {
    return &Service{repo: repo}
}

// ProvideRepository creates a new user repository
func ProvideRepository() *Repository {
    return &Repository{users: make(map[uuid.UUID]*models.User)}
}
```

## Project Structure

```
example/
├── cmd/
│   └── server/
│       └── main.go                    # Server entry point
├── internal/
│   ├── api/
│   │   ├── server.go                 # Server (routes generated by taskw)
│   │   ├── wire.go                   # Wire config (providers generated by taskw)
│   │   ├── adapters.go               # Service adapters
│   │   ├── routes_gen.go            # 🚨 GENERATED by taskw (placeholder)
│   │   └── dependencies_gen.go      # 🚨 GENERATED by taskw (placeholder)
│   ├── models/                       # Shared data models
│   │   ├── user.go
│   │   ├── product.go
│   │   └── order.go
│   ├── user/                         # User module
│   │   ├── handler.go               # 6 endpoints with @Router annotations
│   │   ├── service.go               # Business logic + ProvideService
│   │   └── repository.go            # Data layer + ProvideRepository
│   ├── product/                      # Product module
│   │   ├── handler.go               # 7 endpoints with @Router annotations
│   │   ├── service.go               # Business logic + ProvideService
│   │   └── repository.go            # Data layer + ProvideRepository
│   └── order/                        # Order module
│       ├── handler.go               # 6 endpoints with @Router annotations
│       ├── service.go               # Business logic + ProvideService
│       └── repository.go            # Data layer + ProvideRepository
├── .taskwignore                      # TaskW ignore patterns
├── taskw.yaml                        # TaskW configuration
├── go.mod
└── README.md
```

### Key Files

- **`routes_gen.go`** - Generated by taskw from `@Router` annotations (currently placeholder)
- **`dependencies_gen.go`** - Generated by taskw from `Provide*` functions (currently placeholder)
- **`.taskwignore`** - Tells taskw which files to ignore during scanning
- **`taskw.yaml`** - TaskW configuration for scan directories and output

## API Endpoints

### Users (`/api/v1/users`)

- `GET /` - Get all users
- `GET /{id}` - Get user by ID
- `POST /` - Create user
- `PUT /{id}` - Update user
- `DELETE /{id}` - Delete user
- `GET /by-email?email=` - Get user by email
- `GET /{user_id}/orders` - Get user's orders

### Products (`/api/v1/products`)

- `GET /` - Get all products (with category filter)
- `GET /{id}` - Get product by ID
- `POST /` - Create product
- `PUT /{id}` - Update product
- `DELETE /{id}` - Delete product
- `GET /{id}/stock?quantity=` - Check stock availability

### Categories (`/api/v1/categories`)

- `GET /` - Get all categories

### Orders (`/api/v1/orders`)

- `GET /` - Get all orders (with user/status filters)
- `GET /{id}` - Get order by ID
- `POST /?user_id=` - Create order
- `PUT /{id}/status` - Update order status
- `POST /{id}/cancel` - Cancel order

## Step-by-Step TaskW Testing Workflow

### 1. Prerequisites

```bash
# Navigate to the example
cd example

# Install dependencies
go mod tidy

# Install taskw (replace with your actual taskw binary path)
# go install github.com/nkaewam/taskw@latest
```

### 2. Verify Project State (Before TaskW)

The project should currently **fail to compile**:

```bash
# This should fail because routes_gen.go and dependencies_gen.go are placeholders
go build cmd/server/main.go
# Expected: compilation errors about missing providers
```

### 3. TaskW Configuration

The project comes with a pre-configured `taskw.yaml`:

```yaml
version: "1.0"
project:
  module: "github.com/example/ecommerce-api"
paths:
  scan_dirs:
    - "./internal/user"
    - "./internal/product"
    - "./internal/order"
  output_dir: "./internal/api"
generation:
  routes:
    enabled: true
    output_file: "routes_gen.go"
  dependencies:
    enabled: true
    output_file: "dependencies_gen.go"
```

### 4. Scan and Preview

```bash
# See what taskw discovers
taskw scan
```

Expected output:

```
🔍 Scanning codebase...
📋 Using ignore patterns from .taskwignore

📊 Scan Results:
   🎯 Handlers found: 3
   🛣️  Routes found: 19
   📦 Providers found: 9
   📄 Packages scanned: 3

🎯 Handlers:
   - user.ProvideHandler -> *user.Handler
   - product.ProvideHandler -> *product.Handler
   - order.ProvideHandler -> *order.Handler

🛣️  Routes:
   - GetUsers: GET /api/v1/users
   - GetUser: GET /api/v1/users/{id}
   - CreateUser: POST /api/v1/users
   - UpdateUser: PUT /api/v1/users/{id}
   - DeleteUser: DELETE /api/v1/users/{id}
   - GetUserByEmail: GET /api/v1/users/by-email
   - GetProducts: GET /api/v1/products
   - GetProduct: GET /api/v1/products/{id}
   - CreateProduct: POST /api/v1/products
   - UpdateProduct: PUT /api/v1/products/{id}
   - DeleteProduct: DELETE /api/v1/products/{id}
   - GetCategories: GET /api/v1/categories
   - CheckStock: GET /api/v1/products/{id}/stock
   - GetOrders: GET /api/v1/orders
   - GetOrder: GET /api/v1/orders/{id}
   - CreateOrder: POST /api/v1/orders
   - UpdateOrderStatus: PUT /api/v1/orders/{id}/status
   - CancelOrder: POST /api/v1/orders/{id}/cancel
   - GetUserOrders: GET /api/v1/users/{user_id}/orders

📦 Providers:
   - user.ProvideRepository() -> *user.Repository
   - user.ProvideService() -> *user.Service
   - user.ProvideHandler() -> *user.Handler
   - product.ProvideRepository() -> *product.Repository
   - product.ProvideService() -> *product.Service
   - product.ProvideHandler() -> *product.Handler
   - order.ProvideRepository() -> *order.Repository
   - order.ProvideService() -> *order.Service
   - order.ProvideHandler() -> *order.Handler
```

### 5. Generate Code

```bash
# Generate routes and dependencies
taskw generate

# Or generate specific parts
taskw generate routes
taskw generate deps
```

This should create:

- `internal/api/routes_gen.go` - Auto-generated route registration
- `internal/api/dependencies_gen.go` - Auto-generated Wire provider sets

### 6. Update Wire Configuration

After generation, update `internal/api/wire.go` to include the generated providers.

Uncomment this line in the `ProviderSet`:

```go
// Change this:
// GeneratedProviderSet,

// To this:
GeneratedProviderSet,
```

The final `ProviderSet` should look like:

```go
var ProviderSet = wire.NewSet(
    // Infrastructure providers (manual)
    provideLogger,
    provideFiberApp,

    // Adapters (manual)
    ProvideProductServiceAdapter,
    ProvideUserServiceAdapter,

    // Server (manual)
    ProvideServer,

    // Generated providers (from taskw)
    GeneratedProviderSet,  // Now uncommented!
)
```

### 7. Generate Wire Code

```bash
# Generate Wire dependency injection
go generate ./...

# Or manually
cd internal/api
wire
```

### 8. Verify Generated Code

After taskw generation, the placeholder files should be replaced:

- **`routes_gen.go`** - Should contain actual route registration code
- **`dependencies_gen.go`** - Should contain actual Wire provider set

The project should now compile successfully!

### 9. Test the Server

```bash
# Build and run
go build -o bin/server cmd/server/main.go
./bin/server

# Or with go run
go run cmd/server/main.go
```

## Testing the API

### 1. Health Check

```bash
curl http://localhost:3000/health
```

### 2. Create Test Data

```bash
# Create a user
curl -X POST http://localhost:3000/api/v1/users \
  -H "Content-Type: application/json" \
  -d '{"email":"john@example.com","first_name":"John","last_name":"Doe"}'

# Create a product
curl -X POST http://localhost:3000/api/v1/products \
  -H "Content-Type: application/json" \
  -d '{
    "name":"Gaming Laptop",
    "description":"High-performance gaming laptop",
    "price":1299.99,
    "stock":5,
    "category_id":"550e8400-e29b-41d4-a716-446655440001"
  }'
```

### 3. Test Relationships

```bash
# Create an order (replace with actual IDs from above)
curl -X POST "http://localhost:3000/api/v1/orders?user_id=<user_id>" \
  -H "Content-Type: application/json" \
  -d '{
    "items":[
      {"product_id":"<product_id>","quantity":2}
    ]
  }'

# Update order status
curl -X PUT http://localhost:3000/api/v1/orders/<order_id>/status \
  -H "Content-Type: application/json" \
  -d '{"status":"confirmed"}'
```

### 4. Test Filters and Queries

```bash
# Get products by category
curl "http://localhost:3000/api/v1/products?category=550e8400-e29b-41d4-a716-446655440001"

# Get orders by user
curl "http://localhost:3000/api/v1/orders?user_id=<user_id>"

# Get orders by status
curl "http://localhost:3000/api/v1/orders?status=pending"

# Check stock
curl "http://localhost:3000/api/v1/products/<product_id>/stock?quantity=3"
```

## What TaskW Should Generate

### Expected Generated Code

After running `taskw generate`, the placeholder files should be replaced with actual generated code.

**Expected `routes_gen.go`:**

```go
package api

import "github.com/gofiber/fiber/v2"

func (s *Server) RegisterRoutes(app *fiber.App) {
    api := app.Group("/api/v1")

    // Auto-generated from @Router annotations
    api.Get("/users", s.userHandler.GetUsers)
    api.Get("/users/:id", s.userHandler.GetUser)
    api.Post("/users", s.userHandler.CreateUser)
    api.Put("/users/:id", s.userHandler.UpdateUser)
    api.Delete("/users/:id", s.userHandler.DeleteUser)
    api.Get("/users/by-email", s.userHandler.GetUserByEmail)
    api.Get("/users/:user_id/orders", s.orderHandler.GetUserOrders)

    api.Get("/products", s.productHandler.GetProducts)
    api.Get("/products/:id", s.productHandler.GetProduct)
    api.Post("/products", s.productHandler.CreateProduct)
    api.Put("/products/:id", s.productHandler.UpdateProduct)
    api.Delete("/products/:id", s.productHandler.DeleteProduct)
    api.Get("/products/:id/stock", s.productHandler.CheckStock)

    api.Get("/categories", s.productHandler.GetCategories)

    api.Get("/orders", s.orderHandler.GetOrders)
    api.Get("/orders/:id", s.orderHandler.GetOrder)
    api.Post("/orders", s.orderHandler.CreateOrder)
    api.Put("/orders/:id/status", s.orderHandler.UpdateOrderStatus)
    api.Post("/orders/:id/cancel", s.orderHandler.CancelOrder)

    s.logger.Info("All routes registered successfully")
}
```

**Expected `dependencies_gen.go`:**

```go
package api

import (
    "github.com/google/wire"
    "github.com/example/ecommerce-api/internal/user"
    "github.com/example/ecommerce-api/internal/product"
    "github.com/example/ecommerce-api/internal/order"
)

var GeneratedProviderSet = wire.NewSet(
    // Auto-generated from Provide* functions
    user.ProvideRepository,
    user.ProvideService,
    user.ProvideHandler,
    product.ProvideRepository,
    product.ProvideService,
    product.ProvideHandler,
    order.ProvideRepository,
    order.ProvideService,
    order.ProvideHandler,
)
```

## Features Tested

This example tests taskw's ability to:

✅ **Scan Multiple Modules** - User, Product, Order modules  
✅ **Extract @Router Annotations** - 19 different endpoints  
✅ **Extract Provider Functions** - 9 provider functions  
✅ **Handle Different HTTP Methods** - GET, POST, PUT, DELETE  
✅ **Parse Route Parameters** - Path params like `/{id}`, `/{user_id}`  
✅ **Parse Query Parameters** - Query params in annotations  
✅ **Handle Complex Routes** - Nested resources, multiple params  
✅ **Generate Route Registration** - Fiber-specific syntax  
✅ **Generate Wire Providers** - Wire.NewSet with all providers  
✅ **Cross-Module Dependencies** - Order depends on User/Product services

## Complete Testing Workflow

### Before TaskW Generation

```bash
cd example

# Project should fail to build
go build cmd/server/main.go
# Error: routes_gen.go has placeholder content
# Error: dependencies_gen.go has incomplete provider set
```

### After TaskW Generation

```bash
# 1. Scan what taskw finds
taskw scan

# 2. Generate the code
taskw generate

# 3. Update wire.go (uncomment GeneratedProviderSet)

# 4. Generate wire code
go generate ./...

# 5. Build should now succeed
go build cmd/server/main.go

# 6. Run the server
./server
# OR
go run cmd/server/main.go
```

## Troubleshooting

### Before Generation Issues

**Problem**: `go build` fails with placeholder errors  
**Solution**: This is expected! Run `taskw generate` first.

### TaskW Not Finding Handlers

- Check that files end with `handler.go`
- Ensure `Provide*` functions exist and return correct types
- Verify `@Router` annotations are properly formatted
- Check `.taskwignore` isn't excluding your files

### After Generation Issues

**Problem**: Still can't build after `taskw generate`  
**Solutions**:

- Check `taskw.yaml` has correct module path
- Ensure `scan_dirs` point to the right directories
- Verify output directory is writable
- Uncomment `GeneratedProviderSet` in `wire.go`

**Problem**: Wire compilation issues  
**Solutions**:

- Run `go mod tidy` after generation
- Run `go generate ./...` to update wire_gen.go
- Check that all provider function signatures match
- Ensure interfaces are properly implemented (adapters.go)

**Problem**: Server won't start  
**Solutions**:

- Check that Wire generated `wire_gen.go` exists
- Verify all imports are correct in generated files
- Check for circular dependencies in provider chain

### TaskW Generation Issues

**Problem**: TaskW generates empty or incorrect code  
**Solutions**:

- Verify `@Router` annotations follow exact format: `// @Router /path [method]`
- Ensure `Provide*` functions return pointer types (e.g., `*Handler`)
- Check that handler methods have correct signature: `func (h *Handler) Method(c *fiber.Ctx) error`
- Run `taskw scan` to debug what taskw is finding

---

This example provides a comprehensive test case for taskw, covering all the patterns and edge cases you're likely to encounter in a real-world Go API project.
