# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a Go web API project built with modern tooling using Fiber, Ent ORM, Wire dependency injection, and includes code generation via taskw. The project follows a clean architecture pattern with clear separation between handlers, services, and repositories.

## Essential Commands

### Development
- `task dev` - Start development server with hot reload (uses Air)
- `task generate` - Generate all code (Ent entities, taskw routes/dependencies, Wire DI, Swagger docs)
- `task build` - Build the production binary
- `task test` - Run all tests
- `task setup` - Initial project setup (dependencies + code generation)
- `task clean` - Clean generated files and binaries
- `task fix` - Run golangci-lint with auto-fix

### Environment-Specific Commands
- `task test` - Run in test environment
- `task staging` - Run in staging environment  
- `task prod` - Run in production environment

### Code Generation (Critical)
- `taskw generate all` - Generate routes and dependencies (must run after schema changes)
- `go run -mod=mod entgo.io/ent/cmd/ent generate ./ent/schema` - Generate Ent entities
- `wire ./internal/api` - Generate dependency injection code
- `swag init -g ./cmd/server/main.go -o ./docs` - Generate Swagger documentation

### Database & Infrastructure
- `task check-local-db` - Check PostgreSQL database connection
- `task new-entity NAME=<name>` - Create new Ent entity (e.g., `task new-entity NAME=Product`)

### Testing & Performance
- `task test-concurrency` - Test high concurrency packages
- `task benchmark` - Run performance benchmarks
- `task stress-test` - Run stress test with high concurrency
- `task monitor` - Monitor system metrics
- `task example` - Run high concurrency example
- `task metrics` - Start metrics server only

## Architecture

### Core Technology Stack
- **Web Framework**: Fiber v2 (high-performance HTTP framework)
- **ORM**: Ent (Facebook's entity framework)
- **Dependency Injection**: Google Wire
- **Configuration**: Viper with TOML files
- **Logging**: Zap (structured JSON logging)
- **API Documentation**: Swagger
- **Hot Reload**: Air (development only)

### Project Structure
```
├── cmd/server/           # Application entry point
├── configs/             # Environment-specific TOML config files
├── ent/                 # Ent generated code and schema definitions
├── internal/
│   ├── api/            # Router, server setup, and Wire configuration
│   ├── middleware/     # HTTP middleware (CORS, logging, validation, etc.)
│   ├── pkg/           # Shared utilities (config, logger, types, errors)
│   ├── user/          # User domain module (handler, service, repository)
│   └── health/        # Health check endpoint
├── docs/              # Auto-generated Swagger documentation
└── Taskfile.yml       # Task automation
```

### Generated Files (DO NOT EDIT MANUALLY)
- `internal/api/routes_gen.go` - Generated by taskw
- `internal/api/dependencies_gen.go` - Generated by taskw  
- `internal/api/wire_gen.go` - Generated by Wire
- `ent/*.go` - Generated by Ent (except schema files)
- `docs/` directory - Generated by Swagger

### Architecture Pattern
The project uses a 3-layer architecture within domain modules:
1. **Handler** - HTTP request/response handling, validation (`handler.go`)
2. **Service** - Business logic, data transformation, transaction management (`service.go`)
3. **Repository** - Data access layer, database operations (`repository.go`)

### Domain Entities
The project includes the following Ent entities:
- **User** - Basic user management with name, email, age
- **Blockchain** - Blockchain network definitions
- **Collection** - NFT collections
- **NFT** - Individual NFT tokens
- **NFTHolder** - NFT ownership tracking

## Configuration

### Environment Configuration
Configuration uses TOML files in the `configs/` directory:
- `config.dev.toml` - Development (default)
- `config.prod.toml` - Production
- `config.test.toml` - Testing
- `config.staging.toml` - Staging
- `config.docker.toml` - Docker environment

Set environment via `ENV` environment variable (defaults to "dev").

### Database Configuration
Currently configured for PostgreSQL in development:
```toml
[db]
driver = "postgres"
dsn = "postgres://postgres:postgres@localhost:5432/example?sslmode=disable"
```

## API Conventions

### Route Format
- **Method**: All endpoints use POST
- **Path Pattern**: `/api/v{version}/{domain.action}`
- **Examples**: `/api/user.create`, `/api/user.list`

### Request/Response Format
- **Content-Type**: `application/json`
- **Parameters**: All in JSON body
- **Pagination**: Uses `offset` and `limit`
- **Sorting**: Uses `field` and `asc` boolean

### Response Structure
```json
{
  "status": "success|fail",
  "code": 200,
  "error": "",
  "data": {}
}
```

## Development Workflow

### Before Making Changes
1. Always run `task generate` after modifying:
   - Ent schema files (`ent/schema/*.go`)
   - API routes or handlers
   - Wire dependency configurations

### Adding New Endpoints
1. Create handler in appropriate module (e.g., `internal/user/handler.go`)
2. Add service logic in `service.go` 
3. Add repository methods in `repository.go` if needed
4. Run `task generate` to update routes and dependencies
5. Add Swagger documentation comments to handlers

### Adding New Domain Modules
1. Create new directory under `internal/` (e.g., `internal/product/`)
2. Create `handler.go`, `service.go`, and `repository.go` files
3. Follow existing patterns from `internal/user/` module
4. Run `task generate` to register new handlers automatically
5. Add Ent schema if database entities are needed

### Database Changes
1. Modify schema in `ent/schema/*.go`
2. Run `task generate` to regenerate Ent code
3. Test migration behavior

## Important Notes

- **taskw Dependency**: This project relies on taskw for route and dependency generation
- **Wire Integration**: Dependency injection is handled by Google Wire
- **All POST Pattern**: The API uses POST for all endpoints (unconventional but project-specific)
- **Middleware Chain**: Request processing goes through CORS → Trace → Logger → Recovery → Validator → Response middlewares
- **Error Handling**: Uses custom error codes with 6-digit format (XXYYZZ)
- **Structured Logging**: All logs are JSON-formatted using Zap
- **Air Configuration**: Uses custom Air config (`.air.toml`) with port cleanup on restart
- **NFT Focus**: Project includes NFT-related entities and may be blockchain/Web3 oriented

## Testing

Run tests with: `task test`

The project includes specific test commands for concurrency features:
- `task test-concurrency` - Test high concurrency packages
- `task benchmark` - Run performance benchmarks

## Monitoring & Metrics

- Health endpoint: `/health`
- Swagger docs: `/docs`
- The project includes built-in metrics and monitoring capabilities

## Key Files to Understand

- `cmd/server/main.go` - Application entry point with detailed startup logging
- `internal/api/wire.go` - Wire dependency injection configuration
- `internal/api/server.go` - Fiber app configuration
- `taskw.yaml` - taskw configuration for code generation
- `Taskfile.yml` - All available development tasks